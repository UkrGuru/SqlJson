// Copyright (c) Oleksandr Viktor (UkrGuru). All rights reserved.
// Licensed under the MIT License. See License.txt in the project root for license information.

using System.Reflection;
using System.Text;
using UkrGuru.Extensions.Data;
using UkrGuru.SqlJson;

namespace UkrGuru.Extensions;

public class DbFileTests
{
    public DbFileTests()
    {
        if (GlobalTests.DbOk) return;

        DbHelper.ConnectionString = GlobalTests.ConnectionString;
        
        Assembly.GetAssembly(typeof(DbFile)).InitDb();

        GlobalTests.DbOk = true;
    }

    [Theory]
    [InlineData("file.html", "<html><head></head><title>TEST</title><body>TESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTESTTEST</body></html>")]
    public async Task CanCompressDecompress(string filename, string content, CancellationToken cancellationToken = default)
    {
        var sourceBytes = Encoding.UTF8.GetBytes(content);

        DbFile file = new() { FileName = filename, FileContent = sourceBytes };

        await file.CompressAsync(cancellationToken);

        Assert.EndsWith(".gzip", file.FileName);

        await file.DecompressAsync(cancellationToken);

        Assert.Equal(filename, file.FileName);

        Assert.Equal(sourceBytes, file.FileContent);
    }

    [Theory]
    [InlineData("12345678901234567890123456789012345678901234567890")]
    [InlineData("123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890")]
    public async Task CanSaveLoadDelete(string content, CancellationToken cancellationToken = default)
    {
        var guid1 = await DbFileHelper.SetAsync(content, cancellationToken: cancellationToken);

        var guid2 = await DbFileHelper.SetAsync(content, cancellationToken: cancellationToken);

        Assert.Equal(guid1, guid2);

        var content1 = await DbFileHelper.GetAsync(guid1, cancellationToken);

        Assert.Equal(content, content1);

        if (!string.IsNullOrEmpty(guid1) && Guid.TryParse(guid1, out Guid guid))
        {
            await DbFileHelper.DelAsync(guid, cancellationToken);

            content1 = await DbFileHelper.GetAsync(guid1, cancellationToken);

            Assert.Null(content1);
        }
    }

    [Fact]
    public async Task CanSaveBinFile()
    {
        var content = new byte[256]; for (int i = 0; i < 256; i++) content[i] = (byte)i;

        var guid = await DbHelper.ExecAsync<string?>("WJbFiles_Ins", new DbFile { FileName = "test.bin", FileContent = content });

        var file = await DbHelper.ExecAsync<DbFile>("WJbFiles_Get", guid);

        Assert.Equal(file?.FileContent, content);
    }
}